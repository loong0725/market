{% extends 'admin/base.html' %}

{% block content %}
<h2 style="margin-bottom: 24px; color: #495057; display: flex; align-items: center; gap: 8px;">
    ðŸ‘¥ User Management
    <span style="font-size: 14px; font-weight: normal; color: #6c757d;">({{ users.paginator.count }} total)</span>
</h2>

<!-- Bulk Actions Bar -->
<div class="bulk-actions" id="bulkActions">
    <span class="count" id="selectedCount">0 selected</span>
    <button class="btn btn-success btn-sm" onclick="bulkAction('verify')">Verify Selected</button>
    <button class="btn btn-sm" style="background: #17a2b8; color: white;" onclick="bulkAction('activate')">Activate Selected</button>
    <button class="btn btn-danger btn-sm" onclick="bulkAction('deactivate')">Deactivate Selected</button>
    <button class="btn btn-sm" style="background: #6c757d; color: white;" onclick="clearSelection()">Clear</button>
</div>

<div class="toolbar">
    <form method="get" class="search-box">
        <input type="text" name="search" placeholder="ðŸ” Search username or email..." value="{{ search }}" autocomplete="off">
        <button type="submit" class="btn btn-primary" style="position: absolute; right: 0; top: 0; height: 100%; border-radius: 0 8px 8px 0;">Search</button>
    </form>
    
    <div style="display: flex; gap: 8px;">
        <a href="?is_active=1" class="btn btn-success btn-sm">Active Users</a>
        <a href="?is_verified=1" class="btn btn-sm" style="background: #17a2b8; color: white;">Verified</a>
        <a href="?is_verified=0" class="btn btn-sm" style="background: #ffc107; color: white;">Unverified</a>
        <a href="{% url 'admin_users' %}" class="btn btn-sm" style="background: #6c757d; color: white;">Reset</a>
    </div>
</div>

<table>
    <thead>
        <tr>
            <th style="width: 50px;">
                <input type="checkbox" id="selectAll" class="checkbox" title="Select all">
            </th>
            <th class="sortable">ID</th>
            <th class="sortable">Username</th>
            <th class="sortable">Email</th>
            <th>Status</th>
            <th class="sortable">Items</th>
            <th class="sortable">Orders</th>
            <th class="sortable">Joined</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for user_obj in users %}
        <tr>
            <td>
                <input type="checkbox" name="selected_ids" value="{{ user_obj.id }}" class="checkbox">
            </td>
            <td>{{ user_obj.id }}</td>
            <td><strong>{{ user_obj.username }}</strong></td>
            <td>{{ user_obj.ait_email|default:user_obj.email }}</td>
            <td>
                {% if user_obj.is_active %}
                <span class="badge badge-success">Active</span>
                {% else %}
                <span class="badge badge-danger">Disabled</span>
                {% endif %}
                {% if user_obj.is_verified %}
                <span class="badge badge-info" style="margin-left: 4px;">Verified</span>
                {% else %}
                <span class="badge badge-warning" style="margin-left: 4px;">Unverified</span>
                {% endif %}
            </td>
            <td>{{ user_obj.items_count }}</td>
            <td>{{ user_obj.orders_count }}</td>
            <td>{{ user_obj.date_joined|date:"M d, Y" }}</td>
            <td>
                <form method="post" action="{% url 'admin_users_action' user_obj.id %}" style="display: inline;" onsubmit="return confirmAction('Are you sure?', this)">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="toggle_active">
                    <button type="submit" class="btn btn-sm {% if user_obj.is_active %}btn-danger{% else %}btn-success{% endif %}">
                        {% if user_obj.is_active %}Disable{% else %}Enable{% endif %}
                    </button>
                </form>
                {% if not user_obj.is_verified %}
                <form method="post" action="{% url 'admin_users_action' user_obj.id %}" style="display: inline; margin-left: 4px;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="verify">
                    <button type="submit" class="btn btn-sm btn-primary">Verify</button>
                </form>
                {% endif %}
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="9">
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸ‘¤</div>
                    <h3>No Users Found</h3>
                    <p>Try adjusting your search or filters</p>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% if users.has_other_pages %}
<div class="pagination">
    {% if users.has_previous %}
    <a href="?page={{ users.previous_page_number }}{% if search %}&search={{ search }}{% endif %}">â€¹ Previous</a>
    {% else %}
    <span class="disabled">â€¹ Previous</span>
    {% endif %}
    
    {% for num in users.paginator.page_range %}
        {% if users.number == num %}
        <span class="active">{{ num }}</span>
        {% elif num > users.number|add:"-3" and num < users.number|add:"3" %}
        <a href="?page={{ num }}{% if search %}&search={{ search }}{% endif %}">{{ num }}</a>
        {% endif %}
    {% endfor %}
    
    {% if users.has_next %}
    <a href="?page={{ users.next_page_number }}{% if search %}&search={{ search }}{% endif %}">Next â€º</a>
    {% else %}
    <span class="disabled">Next â€º</span>
    {% endif %}
    
    <span style="margin-left: 16px; color: #6c757d; font-size: 14px;">
        Showing {{ users.start_index }}-{{ users.end_index }} of {{ users.paginator.count }}
    </span>
</div>
{% endif %}

<script>
function confirmAction(message, form) {
    showConfirm('Confirm Action', message, function() {
        form.submit();
    });
    return false;
}

function bulkAction(action) {
    const selected = Array.from(document.querySelectorAll('input[name="selected_ids"]:checked')).map(cb => cb.value);
    if (selected.length === 0) {
        showToast('Please select at least one user', 'error');
        return;
    }
    
    const actionText = {
        'verify': 'verify',
        'activate': 'activate',
        'deactivate': 'deactivate'
    }[action];
    
    showConfirm('Confirm Bulk Action', `Are you sure you want to ${actionText} ${selected.length} user(s)?`, function() {
        // Create a form and submit
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "admin_users" %}';
        
        const csrf = document.createElement('input');
        csrf.type = 'hidden';
        csrf.name = 'csrfmiddlewaretoken';
        csrf.value = '{{ csrf_token }}';
        form.appendChild(csrf);
        
        selected.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'selected_ids';
            input.value = id;
            form.appendChild(input);
        });
        
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'bulk_action';
        actionInput.value = action;
        form.appendChild(actionInput);
        
        document.body.appendChild(form);
        form.submit();
    });
}

function clearSelection() {
    document.querySelectorAll('input[name="selected_ids"]').forEach(cb => {
        cb.checked = false;
        cb.closest('tr').classList.remove('selected');
    });
    document.getElementById('selectAll').checked = false;
    document.getElementById('bulkActions').classList.remove('active');
}
</script>
{% endblock %}
